<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livestream System Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #log { background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üöÄ Livestream System Test</h1>
    
    <div class="test-section">
        <h3>1. System Components Check</h3>
        <div id="componentsStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>2. WebRTC Manager Test</h3>
        <button onclick="testWebRTCManager()">Test WebRTC Manager</button>
        <button onclick="testSocketConnection()">Test Socket Connection</button>
        <div id="webrtcStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Media Access Test</h3>
        <button onclick="testMediaAccess()">Test Camera & Microphone</button>
        <div id="mediaStatus"></div>
    </div>
    
    <div class="test-section">
        <h3>4. System Log</h3>
        <div id="log"></div>
    </div>

    <!-- Socket.IO Client -->
    <script src="frontend/socket.io/socket.io.js"></script>
    
    <!-- Custom WebRTC Manager -->
    <script src="frontend/admin/js/custom-webrtc.js"></script>
    
    <script>
        let webrtcManager = null;
        let socket = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.className = type;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.className = type;
            }
        }
        
        // Test 1: Check System Components
        function checkSystemComponents() {
            log('üîç Checking system components...');
            
            let allGood = true;
            let status = '<ul>';
            
            // Check Socket.IO
            if (typeof io !== 'undefined') {
                status += '<li class="success">‚úÖ Socket.IO client available</li>';
                log('‚úÖ Socket.IO client available');
            } else {
                status += '<li class="error">‚ùå Socket.IO client not available</li>';
                log('‚ùå Socket.IO client not available', 'error');
                allGood = false;
            }
            
            // Check CustomWebRTCManager
            if (typeof CustomWebRTCManager !== 'undefined') {
                status += '<li class="success">‚úÖ CustomWebRTCManager class available</li>';
                log('‚úÖ CustomWebRTCManager class available');
            } else {
                status += '<li class="error">‚ùå CustomWebRTCManager class not available</li>';
                log('‚ùå CustomWebRTCManager class not available', 'error');
                allGood = false;
            }
            
            status += '</ul>';
            
            if (allGood) {
                status += '<p class="success"><strong>üéâ All components are available!</strong></p>';
                log('üéâ All system components are available!', 'success');
            } else {
                status += '<p class="error"><strong>‚ö†Ô∏è Some components are missing!</strong></p>';
                log('‚ö†Ô∏è Some system components are missing!', 'warning');
            }
            
            updateStatus('componentsStatus', status);
        }
        
        // Test 2: Test WebRTC Manager
        function testWebRTCManager() {
            log('üöÄ Testing WebRTC Manager...');
            
            try {
                if (typeof CustomWebRTCManager === 'undefined') {
                    throw new Error('CustomWebRTCManager class not available');
                }
                
                webrtcManager = new CustomWebRTCManager();
                log('‚úÖ WebRTC Manager created successfully');
                
                updateStatus('webrtcStatus', 
                    '<p class="success">‚úÖ WebRTC Manager created successfully</p>' +
                    '<p>Manager instance: ' + (webrtcManager ? 'Available' : 'Not available') + '</p>'
                );
                
            } catch (error) {
                log('‚ùå Failed to create WebRTC Manager: ' + error.message, 'error');
                updateStatus('webrtcStatus', 
                    '<p class="error">‚ùå Failed to create WebRTC Manager: ' + error.message + '</p>'
                );
            }
        }
        
        // Test 3: Test Socket Connection
        function testSocketConnection() {
            log('üîå Testing Socket Connection...');
            
            try {
                if (typeof io === 'undefined') {
                    throw new Error('Socket.IO not available');
                }
                
                socket = io();
                
                socket.on('connect', () => {
                    log('‚úÖ Socket connected successfully');
                    updateStatus('webrtcStatus', 
                        '<p class="success">‚úÖ Socket connected successfully</p>' +
                        '<p>Socket ID: ' + socket.id + '</p>'
                    );
                });
                
                socket.on('connect_error', (error) => {
                    log('‚ùå Socket connection failed: ' + error.message, 'error');
                    updateStatus('webrtcStatus', 
                        '<p class="error">‚ùå Socket connection failed: ' + error.message + '</p>'
                    );
                });
                
                socket.on('disconnect', () => {
                    log('üîå Socket disconnected');
                });
                
            } catch (error) {
                log('‚ùå Failed to create socket: ' + error.message, 'error');
                updateStatus('webrtcStatus', 
                    '<p class="error">‚ùå Failed to create socket: ' + error.message + '</p>'
                );
            }
        }
        
        // Test 4: Test Media Access
        function testMediaAccess() {
            log('üìπ Testing Media Access...');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log('‚ùå Media devices not supported', 'error');
                updateStatus('mediaStatus', '<p class="error">‚ùå Media devices not supported</p>');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    log('‚úÖ Camera and microphone access granted');
                    
                    // Stop the stream immediately
                    stream.getTracks().forEach(track => track.stop());
                    
                    updateStatus('mediaStatus', 
                        '<p class="success">‚úÖ Camera and microphone access granted</p>' +
                        '<p>Video tracks: ' + stream.getVideoTracks().length + '</p>' +
                        '<p>Audio tracks: ' + stream.getAudioTracks().length + '</p>'
                    );
                })
                .catch(error => {
                    log('‚ùå Media access denied: ' + error.message, 'error');
                    updateStatus('mediaStatus', 
                        '<p class="error">‚ùå Media access denied: ' + error.message + '</p>'
                    );
                });
        }
        
        // Initialize tests when page loads
        window.addEventListener('load', () => {
            log('üöÄ Livestream System Test initialized');
            checkSystemComponents();
        });
    </script>
</body>
</html>
