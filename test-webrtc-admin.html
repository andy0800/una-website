<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Admin Test Page</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .test-button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .video-container { margin: 20px 0; }
        video { width: 400px; height: 300px; border: 1px solid #ccc; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🧪 WebRTC Admin System Test Page</h1>
    
    <div class="test-section">
        <h2>🔧 System Initialization Tests</h2>
        <button class="test-button" onclick="testSystemInit()">Test System Initialization</button>
        <button class="test-button" onclick="testWebRTCManager()">Test WebRTC Manager</button>
        <button class="test-button" onclick="testSocketConnection()">Test Socket.IO Connection</button>
        <div id="init-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>📹 Media Stream Tests</h2>
        <button class="test-button" onclick="testGetUserMedia()">Test Camera/Microphone Access</button>
        <button class="test-button" onclick="testLocalVideo()">Test Local Video Display</button>
        <div class="video-container">
            <video id="local-video" autoplay muted playsinline></video>
        </div>
        <div id="media-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>🚀 Livestream Tests</h2>
        <button class="test-button" id="startBtn" onclick="testStartLivestream()">Start Livestream</button>
        <button class="test-button" id="stopBtn" onclick="testStopLivestream()" disabled>Stop Livestream</button>
        <button class="test-button" onclick="testStreamState()">Test Stream State</button>
        <div id="stream-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>👥 Viewer Management Tests</h2>
        <button class="test-button" onclick="testViewerJoin()">Simulate Viewer Join</button>
        <button class="test-button" onclick="testViewerLeave()">Simulate Viewer Leave</button>
        <button class="test-button" onclick="testViewerCount()">Test Viewer Count</button>
        <div id="viewer-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>🔗 WebRTC Connection Tests</h2>
        <button class="test-button" onclick="testPeerConnection()">Test Peer Connection Creation</button>
        <button class="test-button" onclick="testOfferAnswer()">Test Offer/Answer Flow</button>
        <button class="test-button" onclick="testICECandidates()">Test ICE Candidates</button>
        <div id="webrtc-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>📊 System Status</h2>
        <button class="test-button" onclick="getSystemStatus()">Get Full System Status</button>
        <div id="system-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>📝 Test Logs</h2>
        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        <div id="test-log" class="log"></div>
    </div>

    <!-- Load Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Load Custom WebRTC Manager -->
    <script src="/admin/js/custom-webrtc.js"></script>

    <script>
        // Global test variables
        let webrtcManager = null;
        let testSocket = null;
        let testStream = null;
        let testPeerConnection = null;

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Update status display
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Test 1: System Initialization
        async function testSystemInit() {
            log('🧪 Testing System Initialization...');
            try {
                // Check if CustomWebRTCManager is available
                if (typeof CustomWebRTCManager === 'undefined') {
                    throw new Error('CustomWebRTCManager class not found');
                }
                log('✅ CustomWebRTCManager class found', 'success');

                // Create instance
                webrtcManager = new CustomWebRTCManager();
                log('✅ WebRTC Manager instance created', 'success');

                // Initialize
                const success = await webrtcManager.init();
                if (success) {
                    log('✅ WebRTC Manager initialized successfully', 'success');
                    updateStatus('init-status', '✅ System initialized successfully', 'success');
                } else {
                    throw new Error('Failed to initialize WebRTC Manager');
                }
            } catch (error) {
                log(`❌ System initialization failed: ${error.message}`, 'error');
                updateStatus('init-status', `❌ Initialization failed: ${error.message}`, 'error');
            }
        }

        // Test 2: WebRTC Manager
        function testWebRTCManager() {
            log('🧪 Testing WebRTC Manager...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                // Test properties
                const hasLocalStream = webrtcManager.localStream !== null;
                const hasSocket = webrtcManager.socket !== null;
                const hasPeerConnections = webrtcManager.peerConnections instanceof Map;

                log(`✅ Local Stream: ${hasLocalStream ? 'Yes' : 'No'}`);
                log(`✅ Socket: ${hasSocket ? 'Yes' : 'No'}`);
                log(`✅ Peer Connections: ${hasPeerConnections ? 'Yes' : 'No'}`);

                updateStatus('init-status', '✅ WebRTC Manager tests passed', 'success');
            } catch (error) {
                log(`❌ WebRTC Manager test failed: ${error.message}`, 'error');
                updateStatus('init-status', `❌ WebRTC Manager test failed: ${error.message}`, 'error');
            }
        }

        // Test 3: Socket.IO Connection
        function testSocketConnection() {
            log('🧪 Testing Socket.IO Connection...');
            try {
                if (!webrtcManager || !webrtcManager.socket) {
                    throw new Error('WebRTC Manager or Socket not available');
                }

                const socket = webrtcManager.socket;
                const isConnected = socket.connected;
                const hasId = !!socket.id;

                log(`✅ Socket Connected: ${isConnected}`);
                log(`✅ Socket ID: ${hasId ? 'Yes' : 'No'}`);

                if (isConnected) {
                    updateStatus('init-status', '✅ Socket.IO connection successful', 'success');
                } else {
                    updateStatus('init-status', '⚠️ Socket.IO not connected', 'info');
                }
            } catch (error) {
                log(`❌ Socket.IO test failed: ${error.message}`, 'error');
                updateStatus('init-status', `❌ Socket.IO test failed: ${error.message}`, 'error');
            }
        }

        // Test 4: Get User Media
        async function testGetUserMedia() {
            log('🧪 Testing Camera/Microphone Access...');
            try {
                testStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                const videoTracks = testStream.getVideoTracks();
                const audioTracks = testStream.getAudioTracks();

                log(`✅ Video Tracks: ${videoTracks.length}`);
                log(`✅ Audio Tracks: ${audioTracks.length}`);

                videoTracks.forEach(track => {
                    log(`  - Video: ${track.label} (${track.enabled ? 'enabled' : 'disabled'})`);
                });

                audioTracks.forEach(track => {
                    log(`  - Audio: ${track.label} (${track.enabled ? 'enabled' : 'disabled'})`);
                });

                updateStatus('media-status', '✅ Camera and microphone access successful', 'success');
            } catch (error) {
                log(`❌ Media access failed: ${error.message}`, 'error');
                updateStatus('media-status', `❌ Media access failed: ${error.message}`, 'error');
            }
        }

        // Test 5: Local Video Display
        function testLocalVideo() {
            log('🧪 Testing Local Video Display...');
            try {
                const videoElement = document.getElementById('local-video');
                if (!videoElement) {
                    throw new Error('Video element not found');
                }

                if (!testStream) {
                    throw new Error('No test stream available. Run camera test first.');
                }

                videoElement.srcObject = testStream;
                videoElement.play().then(() => {
                    log('✅ Local video playing successfully', 'success');
                    updateStatus('media-status', '✅ Local video display working', 'success');
                }).catch(error => {
                    log(`⚠️ Video play failed (may need user interaction): ${error.message}`, 'info');
                    updateStatus('media-status', '⚠️ Video play failed - may need user interaction', 'info');
                });
            } catch (error) {
                log(`❌ Local video test failed: ${error.message}`, 'error');
                updateStatus('media-status', `❌ Local video test failed: ${error.message}`, 'error');
            }
        }

        // Test 6: Start Livestream
        async function testStartLivestream() {
            log('🧪 Testing Livestream Start...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                const result = await webrtcManager.startLivestream('test-livestream');
                
                if (result && result.success) {
                    log('✅ Livestream started successfully', 'success');
                    updateStatus('stream-status', '✅ Livestream active', 'success');
                    
                    // Update button states
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                } else {
                    throw new Error('Livestream start returned false');
                }
            } catch (error) {
                log(`❌ Livestream start failed: ${error.message}`, 'error');
                updateStatus('stream-status', `❌ Livestream start failed: ${error.message}`, 'error');
            }
        }

        // Test 7: Stop Livestream
        async function testStopLivestream() {
            log('🧪 Testing Livestream Stop...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                const result = await webrtcManager.stopLivestream();
                
                if (result) {
                    log('✅ Livestream stopped successfully', 'success');
                    updateStatus('stream-status', '✅ Livestream stopped', 'info');
                    
                    // Update button states
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                } else {
                    throw new Error('Livestream stop returned false');
                }
            } catch (error) {
                log(`❌ Livestream stop failed: ${error.message}`, 'error');
                updateStatus('stream-status', `❌ Livestream stop failed: ${error.message}`, 'error');
            }
        }

        // Test 8: Stream State
        function testStreamState() {
            log('🧪 Testing Stream State...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                const status = webrtcManager.getConnectionStatus();
                log('📊 Stream Status:', 'info');
                log(`  - Live: ${status.isLive}`);
                log(`  - Room ID: ${status.roomId || 'None'}`);
                log(`  - Viewers: ${status.viewerCount}`);
                log(`  - Peer Connections: ${status.peerConnections}`);
                log(`  - Local Stream: ${status.localStream}`);
                log(`  - Socket: ${status.socket}`);

                updateStatus('stream-status', `📊 Stream Status: ${status.isLive ? 'LIVE' : 'STOPPED'}`, 'info');
            } catch (error) {
                log(`❌ Stream state test failed: ${error.message}`, 'error');
                updateStatus('stream-status', `❌ Stream state test failed: ${error.message}`, 'error');
            }
        }

        // Test 9: Simulate Viewer Join
        function testViewerJoin() {
            log('🧪 Simulating Viewer Join...');
            try {
                if (!webrtcManager || !webrtcManager.socket) {
                    throw new Error('WebRTC Manager or Socket not available');
                }

                // Simulate viewer join event
                const mockViewerData = {
                    socketId: 'test-viewer-' + Date.now(),
                    userInfo: { name: 'Test Viewer', email: 'test@example.com' },
                    viewerCount: 1
                };

                // Trigger viewer join handler
                if (webrtcManager.socket && webrtcManager.socket.connected) {
                    webrtcManager.socket.emit('viewer-join', mockViewerData);
                    log('✅ Viewer join event emitted', 'success');
                    updateStatus('viewer-status', '✅ Viewer join simulated', 'success');
                } else {
                    throw new Error('Socket not connected');
                }
            } catch (error) {
                log(`❌ Viewer join test failed: ${error.message}`, 'error');
                updateStatus('viewer-status', `❌ Viewer join test failed: ${error.message}`, 'error');
            }
        }

        // Test 10: Simulate Viewer Leave
        function testViewerLeave() {
            log('🧪 Simulating Viewer Leave...');
            try {
                if (!webrtcManager || !webrtcManager.socket) {
                    throw new Error('WebRTC Manager or Socket not available');
                }

                // Simulate viewer disconnect event
                const mockDisconnectData = {
                    socketId: 'test-viewer-' + Date.now(),
                    viewerCount: 0
                };

                // Trigger viewer disconnect handler
                if (webrtcManager.socket && webrtcManager.socket.connected) {
                    webrtcManager.socket.emit('disconnectPeer', mockDisconnectData);
                    log('✅ Viewer disconnect event emitted', 'success');
                    updateStatus('viewer-status', '✅ Viewer leave simulated', 'success');
                } else {
                    throw new Error('Socket not connected');
                }
            } catch (error) {
                log(`❌ Viewer leave test failed: ${error.message}`, 'error');
                updateStatus('viewer-status', `❌ Viewer leave test failed: ${error.message}`, 'error');
            }
        }

        // Test 11: Viewer Count
        function testViewerCount() {
            log('🧪 Testing Viewer Count...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                const count = webrtcManager.getViewerCount();
                log(`✅ Current viewer count: ${count}`, 'success');
                updateStatus('viewer-status', `✅ Viewer count: ${count}`, 'success');
            } catch (error) {
                log(`❌ Viewer count test failed: ${error.message}`, 'error');
                updateStatus('viewer-status', `❌ Viewer count test failed: ${error.message}`, 'error');
            }
        }

        // Test 12: Peer Connection Creation
        function testPeerConnection() {
            log('🧪 Testing Peer Connection Creation...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                // Test creating a peer connection
                const testViewerId = 'test-peer-' + Date.now();
                webrtcManager.createPeerConnection(testViewerId);

                const hasPeerConnection = webrtcManager.peerConnections.has(testViewerId);
                if (hasPeerConnection) {
                    log('✅ Peer connection created successfully', 'success');
                    updateStatus('webrtc-status', '✅ Peer connection creation working', 'success');
                } else {
                    throw new Error('Peer connection not found in manager');
                }
            } catch (error) {
                log(`❌ Peer connection test failed: ${error.message}`, 'error');
                updateStatus('webrtc-status', `❌ Peer connection test failed: ${error.message}`, 'error');
            }
        }

        // Test 13: Offer/Answer Flow
        function testOfferAnswer() {
            log('🧪 Testing Offer/Answer Flow...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                // Test sending offer to a viewer
                const testViewerId = 'test-offer-' + Date.now();
                const mockPeerConnection = {
                    createOffer: async () => ({ type: 'offer', sdp: 'test-sdp' }),
                    setLocalDescription: async () => true
                };

                // Mock the sendOfferToViewer method
                const originalMethod = webrtcManager.sendOfferToViewer;
                webrtcManager.sendOfferToViewer = async (viewerId, pc) => {
                    log(`✅ Offer sent to viewer: ${viewerId}`, 'success');
                    return true;
                };

                webrtcManager.sendOfferToViewer(testViewerId, mockPeerConnection);
                updateStatus('webrtc-status', '✅ Offer/Answer flow working', 'success');

                // Restore original method
                webrtcManager.sendOfferToViewer = originalMethod;
            } catch (error) {
                log(`❌ Offer/Answer test failed: ${error.message}`, 'error');
                updateStatus('webrtc-status', `❌ Offer/Answer test failed: ${error.message}`, 'error');
            }
        }

        // Test 14: ICE Candidates
        function testICECandidates() {
            log('🧪 Testing ICE Candidates...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                // Test ICE candidate handling
                const mockCandidate = {
                    candidate: 'candidate:1234567890',
                    sdpMLineIndex: 0,
                    sdpMid: 'audio'
                };

                const testViewerId = 'test-ice-' + Date.now();
                
                // Test adding ICE candidate
                if (webrtcManager.peerConnections.has(testViewerId)) {
                    const pc = webrtcManager.peerConnections.get(testViewerId);
                    pc.addIceCandidate(mockCandidate).then(() => {
                        log('✅ ICE candidate added successfully', 'success');
                        updateStatus('webrtc-status', '✅ ICE candidate handling working', 'success');
                    }).catch(error => {
                        log(`⚠️ ICE candidate add failed: ${error.message}`, 'info');
                        updateStatus('webrtc-status', '⚠️ ICE candidate handling partial', 'info');
                    });
                } else {
                    log('⚠️ No peer connection available for ICE test', 'info');
                    updateStatus('webrtc-status', '⚠️ ICE test skipped - no peer connection', 'info');
                }
            } catch (error) {
                log(`❌ ICE candidate test failed: ${error.message}`, 'error');
                updateStatus('webrtc-status', `❌ ICE candidate test failed: ${error.message}`, 'error');
            }
        }

        // Test 15: System Status
        function getSystemStatus() {
            log('🧪 Getting Full System Status...');
            try {
                if (!webrtcManager) {
                    throw new Error('WebRTC Manager not initialized');
                }

                const status = webrtcManager.getConnectionStatus();
                const systemInfo = {
                    webrtcManager: !!webrtcManager,
                    customWebRTCClass: typeof CustomWebRTCManager,
                    socketIO: typeof io,
                    mediaDevices: !!navigator.mediaDevices,
                    getUserMedia: !!navigator.mediaDevices?.getUserMedia,
                    RTCPeerConnection: typeof RTCPeerConnection,
                    status: status
                };

                log('📊 Full System Status:', 'info');
                Object.entries(systemInfo).forEach(([key, value]) => {
                    if (key === 'status') {
                        log(`  - ${key}:`, 'info');
                        Object.entries(value).forEach(([subKey, subValue]) => {
                            log(`    ${subKey}: ${subValue}`, 'info');
                        });
                    } else {
                        log(`  - ${key}: ${value}`, 'info');
                    }
                });

                updateStatus('system-status', '✅ System status retrieved successfully', 'success');
            } catch (error) {
                log(`❌ System status test failed: ${error.message}`, 'error');
                updateStatus('system-status', `❌ System status test failed: ${error.message}`, 'error');
            }
        }

        // Utility function to clear logs
        function clearLogs() {
            document.getElementById('test-log').innerHTML = '';
            log('🧹 Logs cleared');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 WebRTC Admin Test Page Loaded');
            log('📋 Ready to run comprehensive tests');
            log('💡 Start with System Initialization test');
        });
    </script>
</body>
</html>
