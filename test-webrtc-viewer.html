<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Viewer Test Page</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 3px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .test-button:disabled { background: #6c757d; cursor: not-allowed; }
        .status { padding: 10px; margin: 10px 0; border-radius: 3px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .video-container { margin: 20px 0; }
        video { width: 400px; height: 300px; border: 1px solid #ccc; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .chat-container { border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; }
        .chat-box { height: 150px; overflow-y: auto; border: 1px solid #ced4da; padding: 10px; margin: 10px 0; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>ğŸ§ª WebRTC Viewer System Test Page</h1>
    
    <div class="test-section">
        <h2>ğŸ”§ System Initialization Tests</h2>
        <button class="test-button" onclick="testSystemInit()">Test System Initialization</button>
        <button class="test-button" onclick="testWebRTCViewer()">Test WebRTC Viewer</button>
        <button class="test-button" onclick="testSocketConnection()">Test Socket.IO Connection</button>
        <div id="init-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“¹ Media Stream Tests</h2>
        <button class="test-button" onclick="testGetUserMedia()">Test Microphone Access</button>
        <button class="test-button" onclick="testLocalAudio()">Test Local Audio</button>
        <div id="media-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸš€ Stream Connection Tests</h2>
        <button class="test-button" onclick="testJoinStream()">Test Join Stream</button>
        <button class="test-button" onclick="testStreamConnection()">Test Stream Connection</button>
        <button class="test-button" onclick="testStreamState()">Test Stream State</button>
        <div id="stream-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”— WebRTC Connection Tests</h2>
        <button class="test-button" onclick="testPeerConnection()">Test Peer Connection Creation</button>
        <button class="test-button" onclick="testOfferHandling()">Test Offer Handling</button>
        <button class="test-button" onclick="testICECandidates()">Test ICE Candidates</button>
        <div id="webrtc-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“º Remote Video Display</h2>
        <button class="test-button" onclick="testRemoteVideo()">Test Remote Video</button>
        <div class="video-container">
            <video id="viewerVideo" autoplay playsinline></video>
        </div>
        <div id="video-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ¤ Microphone Control Tests</h2>
        <button class="test-button" onclick="testMicRequest()">Test Microphone Request</button>
        <button class="test-button" onclick="testMicMute()">Test Microphone Mute</button>
        <button class="test-button" onclick="testMicUnmute()">Test Microphone Unmute</button>
        <div id="mic-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ’¬ Chat Functionality Tests</h2>
        <button class="test-button" onclick="testChatMessage()">Test Send Chat Message</button>
        <div class="chat-container">
            <div id="chatBox" class="chat-box"></div>
            <input type="text" id="chatInput" placeholder="Type a message..." style="width: 70%; padding: 5px;">
            <button onclick="sendTestMessage()">Send</button>
        </div>
        <div id="chat-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š System Status</h2>
        <button class="test-button" onclick="getSystemStatus()">Get Full System Status</button>
        <div id="system-status" class="status"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“ Test Logs</h2>
        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        <div id="test-log" class="log"></div>
    </div>

    <!-- Load Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Load Custom WebRTC Viewer -->
    <script src="/js/custom-webrtc-viewer.js"></script>

    <script>
        // Global test variables
        let webrtcViewer = null;
        let testStream = null;

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Update status display
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // Test 1: System Initialization
        async function testSystemInit() {
            log('ğŸ§ª Testing System Initialization...');
            try {
                // Check if CustomWebRTCViewer is available
                if (typeof CustomWebRTCViewer === 'undefined') {
                    throw new Error('CustomWebRTCViewer class not found');
                }
                log('âœ… CustomWebRTCViewer class found', 'success');

                // Create instance
                webrtcViewer = new CustomWebRTCViewer();
                log('âœ… WebRTC Viewer instance created', 'success');

                // Wait for initialization
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                if (webrtcViewer.socket) {
                    log('âœ… WebRTC Viewer initialized successfully', 'success');
                    updateStatus('init-status', 'âœ… System initialized successfully', 'success');
                } else {
                    throw new Error('WebRTC Viewer not properly initialized');
                }
            } catch (error) {
                log(`âŒ System initialization failed: ${error.message}`, 'error');
                updateStatus('init-status', `âŒ Initialization failed: ${error.message}`, 'error');
            }
        }

        // Test 2: WebRTC Viewer
        function testWebRTCViewer() {
            log('ğŸ§ª Testing WebRTC Viewer...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                // Test properties
                const hasSocket = webrtcViewer.socket !== null;
                const hasPeerConnection = webrtcViewer.peerConnection !== null;
                const hasLocalStream = webrtcViewer.localStream !== null;
                const hasRoomId = webrtcViewer.roomId !== null;

                log(`âœ… Socket: ${hasSocket ? 'Yes' : 'No'}`);
                log(`âœ… Peer Connection: ${hasPeerConnection ? 'Yes' : 'No'}`);
                log(`âœ… Local Stream: ${hasLocalStream ? 'Yes' : 'No'}`);
                log(`âœ… Room ID: ${hasRoomId ? 'Yes' : 'No'}`);

                updateStatus('init-status', 'âœ… WebRTC Viewer tests passed', 'success');
            } catch (error) {
                log(`âŒ WebRTC Viewer test failed: ${error.message}`, 'error');
                updateStatus('init-status', `âŒ WebRTC Viewer test failed: ${error.message}`, 'error');
            }
        }

        // Test 3: Socket.IO Connection
        function testSocketConnection() {
            log('ğŸ§ª Testing Socket.IO Connection...');
            try {
                if (!webrtcViewer || !webrtcViewer.socket) {
                    throw new Error('WebRTC Viewer or Socket not available');
                }

                const socket = webrtcViewer.socket;
                const isConnected = socket.connected;
                const hasId = !!socket.id;

                log(`âœ… Socket Connected: ${isConnected}`);
                log(`âœ… Socket ID: ${hasId ? 'Yes' : 'No'}`);

                if (isConnected) {
                    updateStatus('init-status', 'âœ… Socket.IO connection successful', 'success');
                } else {
                    updateStatus('init-status', 'âš ï¸ Socket.IO not connected', 'info');
                }
            } catch (error) {
                log(`âŒ Socket.IO test failed: ${error.message}`, 'error');
                updateStatus('init-status', `âŒ Socket.IO test failed: ${error.message}`, 'error');
            }
        }

        // Test 4: Get User Media
        async function testGetUserMedia() {
            log('ğŸ§ª Testing Microphone Access...');
            try {
                testStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: false
                });

                const audioTracks = testStream.getAudioTracks();
                log(`âœ… Audio Tracks: ${audioTracks.length}`);

                audioTracks.forEach(track => {
                    log(`  - Audio: ${track.label} (${track.enabled ? 'enabled' : 'disabled'})`);
                });

                updateStatus('media-status', 'âœ… Microphone access successful', 'success');
            } catch (error) {
                log(`âŒ Microphone access failed: ${error.message}`, 'error');
                updateStatus('media-status', `âŒ Microphone access failed: ${error.message}`, 'error');
            }
        }

        // Test 5: Local Audio
        function testLocalAudio() {
            log('ğŸ§ª Testing Local Audio...');
            try {
                if (!testStream) {
                    throw new Error('No test stream available. Run microphone test first.');
                }

                // Create audio element to test audio
                const audioElement = document.createElement('audio');
                audioElement.srcObject = testStream;
                audioElement.play().then(() => {
                    log('âœ… Local audio playing successfully', 'success');
                    updateStatus('media-status', 'âœ… Local audio working', 'success');
                }).catch(error => {
                    log(`âš ï¸ Audio play failed (may need user interaction): ${error.message}`, 'info');
                    updateStatus('media-status', 'âš ï¸ Audio play failed - may need user interaction', 'info');
                });
            } catch (error) {
                log(`âŒ Local audio test failed: ${error.message}`, 'error');
                updateStatus('media-status', `âŒ Local audio test failed: ${error.message}`, 'error');
            }
        }

        // Test 6: Join Stream
        function testJoinStream() {
            log('ğŸ§ª Testing Join Stream...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                // Simulate joining a stream
                const testRoomId = 'test-room-' + Date.now();
                webrtcViewer.joinStream(testRoomId);

                log('âœ… Join stream test initiated', 'success');
                updateStatus('stream-status', 'âœ… Join stream test initiated', 'success');
            } catch (error) {
                log(`âŒ Join stream test failed: ${error.message}`, 'error');
                updateStatus('stream-status', `âŒ Join stream test failed: ${error.message}`, 'error');
            }
        }

        // Test 7: Stream Connection
        function testStreamConnection() {
            log('ğŸ§ª Testing Stream Connection...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                const isConnected = webrtcViewer.isConnected;
                const hasRemoteStream = !!webrtcViewer.remoteStream;

                log(`âœ… Connected: ${isConnected}`);
                log(`âœ… Remote Stream: ${hasRemoteStream ? 'Yes' : 'No'}`);

                updateStatus('stream-status', `ğŸ“Š Connection: ${isConnected ? 'CONNECTED' : 'DISCONNECTED'}`, 'info');
            } catch (error) {
                log(`âŒ Stream connection test failed: ${error.message}`, 'error');
                updateStatus('stream-status', `âŒ Stream connection test failed: ${error.message}`, 'error');
            }
        }

        // Test 8: Stream State
        function testStreamState() {
            log('ğŸ§ª Testing Stream State...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                log('ğŸ“Š Stream State:', 'info');
                log(`  - Connected: ${webrtcViewer.isConnected}`);
                log(`  - Room ID: ${webrtcViewer.roomId || 'None'}`);
                log(`  - Has Local Stream: ${!!webrtcViewer.localStream}`);
                log(`  - Has Remote Stream: ${!!webrtcViewer.remoteStream}`);
                log(`  - Has Peer Connection: ${!!webrtcViewer.peerConnection}`);

                updateStatus('stream-status', `ğŸ“Š Stream State: ${webrtcViewer.isConnected ? 'CONNECTED' : 'DISCONNECTED'}`, 'info');
            } catch (error) {
                log(`âŒ Stream state test failed: ${error.message}`, 'error');
                updateStatus('stream-status', `âŒ Stream state test failed: ${error.message}`, 'error');
            }
        }

        // Test 9: Peer Connection Creation
        function testPeerConnection() {
            log('ğŸ§ª Testing Peer Connection Creation...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                // Test creating a peer connection
                webrtcViewer.createPeerConnection();

                const hasPeerConnection = !!webrtcViewer.peerConnection;
                if (hasPeerConnection) {
                    log('âœ… Peer connection created successfully', 'success');
                    updateStatus('webrtc-status', 'âœ… Peer connection creation working', 'success');
                } else {
                    throw new Error('Peer connection not created');
                }
            } catch (error) {
                log(`âŒ Peer connection test failed: ${error.message}`, 'error');
                updateStatus('webrtc-status', `âŒ Peer connection test failed: ${error.message}`, 'error');
            }
        }

        // Test 10: Offer Handling
        function testOfferHandling() {
            log('ğŸ§ª Testing Offer Handling...');
            try {
                if (!webrtcViewer || !webrtcViewer.peerConnection) {
                    throw new Error('WebRTC Viewer or Peer Connection not available');
                }

                // Create a mock offer
                const mockOffer = {
                    type: 'offer',
                    sdp: 'v=0\r\no=- 1234567890 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE 0\r\nm=audio 9 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 0.0.0.0\r\na=mid:0\r\na=sendonly\r\na=rtpmap:111 opus/48000/2\r\n'
                };

                // Test offer handling
                webrtcViewer.handleOffer(mockOffer).then(() => {
                    log('âœ… Offer handling test completed', 'success');
                    updateStatus('webrtc-status', 'âœ… Offer handling working', 'success');
                }).catch(error => {
                    log(`âš ï¸ Offer handling test failed: ${error.message}`, 'info');
                    updateStatus('webrtc-status', 'âš ï¸ Offer handling partial', 'info');
                });
            } catch (error) {
                log(`âŒ Offer handling test failed: ${error.message}`, 'error');
                updateStatus('webrtc-status', `âŒ Offer handling test failed: ${error.message}`, 'error');
            }
        }

        // Test 11: ICE Candidates
        function testICECandidates() {
            log('ğŸ§ª Testing ICE Candidates...');
            try {
                if (!webrtcViewer || !webrtcViewer.peerConnection) {
                    throw new Error('WebRTC Viewer or Peer Connection not available');
                }

                // Test ICE candidate handling
                const mockCandidate = {
                    candidate: 'candidate:1234567890',
                    sdpMLineIndex: 0,
                    sdpMid: 'audio'
                };

                webrtcViewer.handleIceCandidate(mockCandidate).then(() => {
                    log('âœ… ICE candidate added successfully', 'success');
                    updateStatus('webrtc-status', 'âœ… ICE candidate handling working', 'success');
                }).catch(error => {
                    log(`âš ï¸ ICE candidate add failed: ${error.message}`, 'info');
                    updateStatus('webrtc-status', 'âš ï¸ ICE candidate handling partial', 'info');
                });
            } catch (error) {
                log(`âŒ ICE candidate test failed: ${error.message}`, 'error');
                updateStatus('webrtc-status', `âŒ ICE candidate test failed: ${error.message}`, 'error');
            }
        }

        // Test 12: Remote Video
        function testRemoteVideo() {
            log('ğŸ§ª Testing Remote Video...');
            try {
                const videoElement = document.getElementById('viewerVideo');
                if (!videoElement) {
                    throw new Error('Video element not found');
                }

                if (webrtcViewer && webrtcViewer.remoteStream) {
                    videoElement.srcObject = webrtcViewer.remoteStream;
                    log('âœ… Remote video stream connected', 'success');
                    updateStatus('video-status', 'âœ… Remote video working', 'success');
                } else {
                    log('âš ï¸ No remote stream available', 'info');
                    updateStatus('video-status', 'âš ï¸ No remote stream available', 'info');
                }
            } catch (error) {
                log(`âŒ Remote video test failed: ${error.message}`, 'error');
                updateStatus('video-status', `âŒ Remote video test failed: ${error.message}`, 'error');
            }
        }

        // Test 13: Microphone Request
        function testMicRequest() {
            log('ğŸ§ª Testing Microphone Request...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                webrtcViewer.requestMic();
                log('âœ… Microphone request sent', 'success');
                updateStatus('mic-status', 'âœ… Microphone request sent', 'success');
            } catch (error) {
                log(`âŒ Microphone request test failed: ${error.message}`, 'error');
                updateStatus('mic-status', `âŒ Microphone request test failed: ${error.message}`, 'error');
            }
        }

        // Test 14: Microphone Mute
        function testMicMute() {
            log('ğŸ§ª Testing Microphone Mute...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                webrtcViewer.muteMic();
                log('âœ… Microphone muted', 'success');
                updateStatus('mic-status', 'âœ… Microphone muted', 'success');
            } catch (error) {
                log(`âŒ Microphone mute test failed: ${error.message}`, 'error');
                updateStatus('mic-status', `âŒ Microphone mute test failed: ${error.message}`, 'error');
            }
        }

        // Test 15: Microphone Unmute
        function testMicUnmute() {
            log('ğŸ§ª Testing Microphone Unmute...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                webrtcViewer.unmuteMic();
                log('âœ… Microphone unmuted', 'success');
                updateStatus('mic-status', 'âœ… Microphone unmuted', 'success');
            } catch (error) {
                log(`âŒ Microphone unmute test failed: ${error.message}`, 'error');
                updateStatus('mic-status', `âŒ Microphone unmute test failed: ${error.message}`, 'error');
            }
        }

        // Test 16: Chat Message
        function testChatMessage() {
            log('ğŸ§ª Testing Chat Message...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                const testMessage = 'Test message from viewer at ' + new Date().toLocaleTimeString();
                webrtcViewer.sendChatMessage(testMessage);
                
                log('âœ… Chat message sent', 'success');
                updateStatus('chat-status', 'âœ… Chat message sent', 'success');
            } catch (error) {
                log(`âŒ Chat message test failed: ${error.message}`, 'error');
                updateStatus('chat-status', `âŒ Chat message test failed: ${error.message}`, 'error');
            }
        }

        // Test 17: Send Test Message
        function sendTestMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message && webrtcViewer) {
                webrtcViewer.sendChatMessage(message);
                chatInput.value = '';
                log(`âœ… Test message sent: ${message}`, 'success');
            } else {
                log('âš ï¸ No message to send or viewer not initialized', 'info');
            }
        }

        // Test 18: System Status
        function getSystemStatus() {
            log('ğŸ§ª Getting Full System Status...');
            try {
                if (!webrtcViewer) {
                    throw new Error('WebRTC Viewer not initialized');
                }

                const systemInfo = {
                    webrtcViewer: !!webrtcViewer,
                    customWebRTCViewerClass: typeof CustomWebRTCViewer,
                    socketIO: typeof io,
                    mediaDevices: !!navigator.mediaDevices,
                    getUserMedia: !!navigator.mediaDevices?.getUserMedia,
                    RTCPeerConnection: typeof RTCPeerConnection,
                    viewerState: {
                        isConnected: webrtcViewer.isConnected,
                        roomId: webrtcViewer.roomId,
                        hasLocalStream: !!webrtcViewer.localStream,
                        hasRemoteStream: !!webrtcViewer.remoteStream,
                        hasPeerConnection: !!webrtcViewer.peerConnection
                    }
                };

                log('ğŸ“Š Full System Status:', 'info');
                Object.entries(systemInfo).forEach(([key, value]) => {
                    if (key === 'viewerState') {
                        log(`  - ${key}:`, 'info');
                        Object.entries(value).forEach(([subKey, subValue]) => {
                            log(`    ${subKey}: ${subValue}`, 'info');
                        });
                    } else {
                        log(`  - ${key}: ${value}`, 'info');
                    }
                });

                updateStatus('system-status', 'âœ… System status retrieved successfully', 'success');
            } catch (error) {
                log(`âŒ System status test failed: ${error.message}`, 'error');
                updateStatus('system-status', `âŒ System status test failed: ${error.message}`, 'error');
            }
        }

        // Utility function to clear logs
        function clearLogs() {
            document.getElementById('test-log').innerHTML = '';
            log('ğŸ§¹ Logs cleared');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ WebRTC Viewer Test Page Loaded');
            log('ğŸ“‹ Ready to run comprehensive tests');
            log('ğŸ’¡ Start with System Initialization test');
        });
    </script>
</body>
</html>
